@page
@model AutoRepairCore.Pages.ServiceOrders.CreateModel
@{
    ViewData["Title"] = "Nueva Orden de Servicio";
}

<div class="d-flex align-items-center mb-4 gap-2">
    <i class="bi bi-clipboard2-plus fs-3 text-primary"></i>
    <h2 class="mb-0">Nueva Orden de Servicio</h2>
</div>

@if (!ViewData.ModelState.IsValid)
{
    <div class="alert alert-danger alert-dismissible fade show" role="alert">
        <strong>Por favor corrija los siguientes errores:</strong>
        <ul class="mb-0 mt-1">
            @foreach (var entry in ViewData.ModelState.Values)
            {
                @foreach (var error in entry.Errors)
                {
                    <li>@error.ErrorMessage</li>
                }
            }
        </ul>
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    </div>
}

<form method="post" id="createForm">

    <div class="card shadow-sm mb-4">
        <div class="card-header bg-primary text-white fw-bold">
            <i class="bi bi-info-circle me-1"></i> Datos de la Orden
        </div>
        <div class="card-body p-0">
            <table class="table table-bordered mb-0">
                <tr>
                    <th class="text-end bg-light" style="width:140px">FOLIO:</th>
                    <td><em class="text-muted">(automático)</em></td>
                </tr>
                <tr>
                    <th class="text-end bg-light">FECHA:</th>
                    <td><strong>@Model.CurrentDate.ToString("dd/MM/yyyy HH:mm")</strong></td>
                </tr>
                <tr>
                    <th class="text-end bg-light">CLIENTE:</th>
                    <td>
                        <select id="customerSelect" class="form-select form-select-sm" asp-for="SelectedCustomerID" asp-items="Model.Customers">
                            <option value="">-- Seleccionar cliente --</option>
                        </select>
                        <div id="customerInfo" class="mt-1 d-none">
                            <span class="badge bg-secondary fs-6">RFC: <span id="customerRfc"></span></span>
                            &nbsp;<span id="customerName" class="fw-semibold"></span>
                        </div>
                        <div id="customerError" class="text-danger small mt-1" style="display:none">
                            Es necesario seleccionar un cliente.
                        </div>
                    </td>
                </tr>
                <tr>
                    <th class="text-end bg-light">VEHÍCULO:</th>
                    <td>
                        <select id="vehicleSelect" class="form-select form-select-sm" name="SelectedSerialNumber">
                            <option value="">-- Primero seleccione un cliente --</option>
                        </select>
                        <div id="vehicleError" class="text-danger small mt-1" style="display:none">
                            Es necesario seleccionar un vehículo.
                        </div>
                    </td>
                </tr>
            </table>
        </div>
    </div>

    <div class="card shadow-sm mb-4">
        <div class="card-header bg-success text-white fw-bold">
            <i class="bi bi-tools me-1"></i> Servicios
        </div>
        <div class="card-body p-0">
            <table class="table table-bordered mb-0" id="servicesTable">
                <thead class="table-success">
                    <tr>
                        <th style="width:110px">ID SERVICIO</th>
                        <th>DESCRIPCIÓN</th>
                        <th style="width:110px">CANTIDAD</th>
                        <th style="width:130px">PRECIO</th>
                        <th style="width:130px">IMPORTE</th>
                        <th style="width:50px"></th>
                    </tr>
                </thead>
                <tbody id="serviceRows">
                    <tr id="emptyRow">
                        <td colspan="6" class="text-center text-muted fst-italic py-3">
                            Aún no se han agregado servicios.
                        </td>
                    </tr>
                </tbody>
                <tfoot>
                    <tr>
                        <td colspan="4" class="text-end fw-bold border-top-0">SUBTOTAL</td>
                        <td id="subtotalCell" class="fw-bold bg-warning text-dark">$0.00</td>
                        <td class="border-top-0"></td>
                    </tr>
                    <tr>
                        <td colspan="4" class="text-end fw-bold border-top-0">IVA (16%)</td>
                        <td id="ivaCell" class="fw-bold bg-warning text-dark">$0.00</td>
                        <td class="border-top-0"></td>
                    </tr>
                    <tr>
                        <td colspan="4" class="text-end fw-bold border-top-0">TOTAL</td>
                        <td id="totalCell" class="fw-bold bg-warning text-dark fs-5">$0.00</td>
                        <td class="border-top-0"></td>
                    </tr>
                </tfoot>
            </table>
        </div>
        <div class="card-footer">
            <div id="servicesError" class="text-danger small mb-2" style="display:none">
                Es necesario agregar al menos un servicio.
            </div>
            <div class="d-flex align-items-end gap-2 flex-wrap">
                <div>
                    <label class="form-label mb-1 fw-semibold">Servicio</label>
                    <select id="serviceDropdown" class="form-select form-select-sm" style="min-width:260px">
                        <option value="">-- Seleccionar servicio --</option>
                        @foreach (var svc in Model.AllServices)
                        {
                            <option value="@svc.ServiceID"
                                    data-name="@svc.Name"
                                    data-cost="@svc.Cost.ToString("F2", System.Globalization.CultureInfo.InvariantCulture)">
                                [@svc.ServiceID] @svc.Name — $@svc.Cost.ToString("N2")
                            </option>
                        }
                    </select>
                </div>
                <div>
                    <label class="form-label mb-1 fw-semibold">Cantidad</label>
                    <input type="number" id="serviceQty" class="form-control form-control-sm"
                           value="1" min="1" max="9999" style="width:80px" />
                </div>
                <button type="button" class="btn btn-success btn-sm" id="addServiceBtn">
                    <i class="bi bi-plus-circle me-1"></i>Agregar
                </button>
            </div>
        </div>
    </div>

    <div class="d-flex gap-2">
        <button type="submit" class="btn btn-primary">
            <i class="bi bi-save me-1"></i>Guardar Orden
        </button>
        <a asp-page="Index" class="btn btn-secondary">
            <i class="bi bi-x-circle me-1"></i>Cancelar
        </a>
    </div>

</form>

@section Scripts {
    <partial name="_ValidationScriptsPartial" />
    <script>
        const IVA = 0.16;
        const MAX_QTY = 9999;
        let serviceRows = [];

        $('#customerSelect').change(function () {
            var customerId = $(this).val();
            var vehicleSelect = $('#vehicleSelect');
            vehicleSelect.empty().append('<option value="">-- Seleccionar vehículo --</option>');
            $('#customerInfo').addClass('d-none');
            $('#customerError').hide();

            if (customerId) {
                $.getJSON('/ServiceOrders/Create?handler=Vehicles&customerId=' + customerId, function (data) {
                    $('#customerRfc').text(data.customerRfc);
                    $('#customerName').text(data.customerName);
                    $('#customerInfo').removeClass('d-none');
                    if (data.vehicles.length === 0) {
                        vehicleSelect.append('<option value="">-- Este cliente no tiene vehículos registrados --</option>');
                    } else {
                        $.each(data.vehicles, function (i, v) {
                            vehicleSelect.append($('<option>').val(v.serialNumber).text(v.display));
                        });
                    }
                });
            }
        });

        $('#addServiceBtn').click(function () {
            var sel = $('#serviceDropdown');
            var id = parseInt(sel.val());
            var name = sel.find(':selected').data('name');
            var cost = parseFloat(sel.find(':selected').data('cost'));
            var qty = parseInt($('#serviceQty').val());

            if (!id) {
                showToast('Seleccione un servicio antes de agregar.', 'danger');
                return;
            }
            if (serviceRows.find(r => r.id === id)) {
                showToast('Este servicio ya fue agregado a la orden.', 'danger');
                return;
            }
            if (isNaN(qty) || qty < 1) {
                showToast('La cantidad debe ser al menos 1.', 'danger');
                $('#serviceQty').val(1);
                return;
            }
            if (qty > MAX_QTY) {
                showToast(`La cantidad no puede superar ${MAX_QTY}.`, 'danger');
                $('#serviceQty').val(MAX_QTY);
                return;
            }

            serviceRows.push({ id, name, cost, qty });
            renderRows();
            $('#servicesError').hide();
            sel.val('');
            $('#serviceQty').val(1);
        });

        function renderRows() {
            var tbody = $('#serviceRows');
            tbody.empty();
            var subtotal = 0;

            if (serviceRows.length === 0) {
                tbody.append('<tr id="emptyRow"><td colspan="6" class="text-center text-muted fst-italic py-3">Aún no se han agregado servicios.</td></tr>');
            } else {
                serviceRows.forEach(function (row, idx) {
                    var importe = row.cost * row.qty;
                    subtotal += importe;
                    tbody.append(`
                        <tr>
                            <td class="text-center align-middle">
                                <span class="badge bg-secondary">${row.id}</span>
                                <input type="hidden" name="SelectedServiceIds" value="${row.id}" />
                            </td>
                            <td class="align-middle">${row.name}</td>
                            <td class="align-middle">
                                <input type="number" name="ServiceQuantities" value="${row.qty}"
                                    min="1" max="${MAX_QTY}"
                                    class="form-control form-control-sm qty-input text-center"
                                    style="width:70px" data-idx="${idx}" />
                            </td>
                            <td class="align-middle">$${row.cost.toLocaleString('es-MX', {minimumFractionDigits:2})}</td>
                            <td class="align-middle fw-semibold">$${importe.toLocaleString('es-MX', {minimumFractionDigits:2})}</td>
                            <td class="align-middle text-center">
                                <button type="button" class="btn btn-sm btn-danger remove-btn" data-idx="${idx}" title="Eliminar servicio">
                                    <i class="bi bi-x-lg"></i>
                                </button>
                            </td>
                        </tr>`);
                });
            }

            var iva = subtotal * IVA;
            var total = subtotal + iva;
            $('#subtotalCell').text('$' + subtotal.toLocaleString('es-MX', {minimumFractionDigits:2}));
            $('#ivaCell').text('$' + iva.toLocaleString('es-MX', {minimumFractionDigits:2}));
            $('#totalCell').text('$' + total.toLocaleString('es-MX', {minimumFractionDigits:2}));
        }

        $(document).on('click', '.remove-btn', function () {
            serviceRows.splice($(this).data('idx'), 1);
            renderRows();
        });

        $(document).on('change', '.qty-input', function () {
            var idx = $(this).data('idx');
            var val = parseInt($(this).val());
            if (isNaN(val) || val < 1) { val = 1; $(this).val(1); }
            if (val > MAX_QTY) { val = MAX_QTY; $(this).val(MAX_QTY); }
            serviceRows[idx].qty = val;
            renderRows();
        });

        $('#createForm').submit(function (e) {
            var valid = true;

            if (!$('#customerSelect').val()) {
                $('#customerError').show();
                valid = false;
            }
            if (!$('#vehicleSelect').val()) {
                $('#vehicleError').show();
                valid = false;
            }
            if (serviceRows.length === 0) {
                $('#servicesError').show();
                valid = false;
            }
            if (!valid) {
                e.preventDefault();
                $('html, body').animate({ scrollTop: 0 }, 400);
            }
        });

        $('#customerSelect').on('change', function () { if ($(this).val()) $('#customerError').hide(); });
        $('#vehicleSelect').on('change', function () { if ($(this).val()) $('#vehicleError').hide(); });

        function showToast(msg, type) {
            const icons = {
                warning: 'bi-exclamation-triangle-fill',
                danger:  'bi-x-octagon-fill',
                success: 'bi-check-circle-fill',
                info:    'bi-info-circle-fill'
            };
            const icon = icons[type] || 'bi-bell-fill';
            const id = 'toast-' + Date.now();
            var toast = $(`
                <div id="${id}" role="alert"
                     style="position:fixed;bottom:1.5rem;right:1.5rem;z-index:9999;min-width:320px;max-width:420px;
                            box-shadow:0 8px 24px rgba(0,0,0,.22);border-radius:.6rem;overflow:hidden;
                            animation:slideInRight .3s ease;">
                    <div class="d-flex align-items-center gap-2 p-3 text-white fw-semibold fs-6 bg-${type}" style="border-radius:.6rem .6rem 0 0">
                        <i class="bi ${icon} fs-5 flex-shrink-0"></i>
                        <span class="flex-grow-1">${msg}</span>
                        <button type="button" class="btn-close btn-close-white ms-2 flex-shrink-0" onclick="$('#${id}').remove()"></button>
                    </div>
                    <div style="height:4px;background:rgba(255,255,255,.3);border-radius:0 0 .6rem .6rem">
                        <div class="toast-bar" style="height:100%;width:100%;background:rgba(255,255,255,.7);transition:width 3.5s linear;border-radius:inherit"></div>
                    </div>
                </div>
                <style>
                    @@keyframes slideInRight { from { transform: translateX(120%); opacity:0; } to { transform: translateX(0); opacity:1; } }
                </style>`);
            $('body').append(toast);
            setTimeout(() => toast.find('.toast-bar').css('width', '0%'), 50);
            setTimeout(() => { toast.css('animation', 'slideInRight .3s ease reverse'); setTimeout(() => toast.remove(), 300); }, 3500);
        }
    </script>
}
